# 棋譜形式の変化記法仕様調査

## KIF形式の変化記法

KIF形式では、変化（分岐）は以下のような記法で表現されます：

### 基本的な変化記法
```
1 ７六歩(77)
2 ３四歩(33)
3 ２六歩(27)

変化：3手
3 ２二角成(88)
4 同銀(33)
```

- `変化：N手` という形式で変化の開始を示す（Nは分岐元の手数）
- 変化の終了は次の本譜の手、別の変化、または棋譜の終了で判断
- 複数の変化がある場合は連続して記載
- 変化の中にさらに変化（入れ子）も可能

### 複数の変化の例
```
1 ７六歩(77)
2 ３四歩(33)
3 ２六歩(27)

変化：2手
2 ８四歩(83)
3 ２六歩(27)

変化：3手
3 ２二角成(88)
4 同銀(33)

本譜に戻る
4 ４八銀(39)
```

## KI2形式の変化記法

KI2形式では、変化は以下のような記法で表現されます：

### 基本的な変化記法
```
☗７六歩 ☖３四歩 ☗２六歩

** ３手目の変化
☗２二角成 ☖同銀
```

- `**` で始まる行がコメントとして扱われ、変化の説明に使用
- 変化の手順は通常の記法で記載
- KIF形式より簡略的で、明示的な変化マーカーはない

## CSA形式の変化記法

CSA形式は基本的にコンピュータ将棋用の形式で、**変化（分岐）を標準でサポートしていません**。

- CSA形式は1つの棋譜を線形に記録することを前提
- 変化を扱う場合は、別ファイルとして保存するか、独自拡張が必要
- 一部のソフトウェアでは `'` で始まる行をコメントとして使用し、変化情報を埋め込むことがある

### 独自拡張の例（非標準）
```
+7776FU
-3334FU
+2726FU
' variation: 3
+8822KA
-3322GI
```

## 実装方針

1. **KIF形式**: 標準的な `変化：N手` 記法をサポート
2. **KI2形式**: コメント行を活用した変化記法をサポート
3. **CSA形式**: 
   - 読み込み: コメント行に変化情報があれば解析（オプション）
   - 書き出し: 変化を無視して本譜のみ出力（標準準拠）
   - または変化を含む場合は警告を表示

## 参考資料

- [将棋棋譜形式](https://www.shogi.or.jp/tsume_shogi/sfen/)
- [KIF形式仕様](http://kakinoki.o.oo7.jp/kif_format.html)
- [CSA標準棋譜ファイル形式](http://www.computer-shogi.org/protocol/record_v22.html)